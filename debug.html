<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LearnSync ç™»å½•è°ƒè¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
    </style>
</head>
<body>
    <h1>LearnSync ç™»å½•è°ƒè¯•å·¥å…·</h1>

    <div class="debug-section">
        <h2>1. åº“æ–‡ä»¶æ£€æŸ¥</h2>
        <div id="library-status">æ£€æŸ¥ä¸­...</div>
    </div>

    <div class="debug-section">
        <h2>2. MD5 åŠŸèƒ½æµ‹è¯•</h2>
        <div id="md5-status">æµ‹è¯•ä¸­...</div>
    </div>

    <div class="debug-section">
        <h2>3. æ•°æ®å­˜å‚¨æµ‹è¯•</h2>
        <div id="storage-status">æµ‹è¯•ä¸­...</div>
    </div>

    <div class="debug-section">
        <h2>4. è®¤è¯æ¨¡å—æµ‹è¯•</h2>
        <div id="auth-status">æµ‹è¯•ä¸­...</div>
    </div>

    <div class="debug-section">
        <h2>5. æ¸…é™¤å’Œä¿®å¤æ•°æ®</h2>
        <button onclick="clearAllData()">æ¸…é™¤æ‰€æœ‰LocalStorageæ•°æ®</button>
        <button onclick="initDefaultData()">é‡æ–°åˆå§‹åŒ–é»˜è®¤æ•°æ®</button>
        <button onclick="fixUsers()">ä¿®å¤ç”¨æˆ·isActiveå­—æ®µ</button>
        <button onclick="location.reload()">é‡æ–°åŠ è½½é¡µé¢</button>
        <div id="clear-status"></div>
    </div>

    <!-- å¼•å…¥åº“æ–‡ä»¶ -->
    <script src="lib/md5.min.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/auth.js"></script>

    <script>
        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œæ‰€æœ‰æµ‹è¯•
        document.addEventListener('DOMContentLoaded', function() {
            checkLibraries();
            testMD5();
            testStorage();
            testAuth();
        });

        function checkLibraries() {
            const statusDiv = document.getElementById('library-status');
            let html = '';

            // æ£€æŸ¥MD5åº“
            if (typeof md5 !== 'undefined') {
                html += '<p class="success">âœ… MD5åº“å·²åŠ è½½</p>';
            } else {
                html += '<p class="error">âŒ MD5åº“æœªåŠ è½½</p>';
            }

            // æ£€æŸ¥Storage
            if (typeof Storage !== 'undefined') {
                html += '<p class="success">âœ… Storageæ¨¡å—å·²åŠ è½½</p>';
            } else {
                html += '<p class="error">âŒ Storageæ¨¡å—æœªåŠ è½½</p>';
            }

            // æ£€æŸ¥Auth
            if (typeof Auth !== 'undefined') {
                html += '<p class="success">âœ… Authæ¨¡å—å·²åŠ è½½</p>';
            } else {
                html += '<p class="error">âŒ Authæ¨¡å—æœªåŠ è½½</p>';
            }

            statusDiv.innerHTML = html;
        }

        function testMD5() {
            const statusDiv = document.getElementById('md5-status');
            let html = '';

            try {
                const adminHash = md5('admin');
                const demoHash = md5('demo');

                html += `<p>MD5('admin') = ${adminHash}</p>`;
                html += `<p>MD5('demo') = ${demoHash}</p>`;

                // æ£€æŸ¥æ˜¯å¦ä¸æœŸæœ›å€¼åŒ¹é…
                const expectedAdminHash = '21232f297a57a5a743894a0e4a801fc3';
                const expectedDemoHash = 'fe01ce2a7fbac8fafaed7c982a04e229';

                if (adminHash === expectedAdminHash) {
                    html += '<p class="success">âœ… admin MD5å“ˆå¸Œæ­£ç¡®</p>';
                } else {
                    html += `<p class="error">âŒ admin MD5å“ˆå¸Œä¸åŒ¹é… (æœŸæœ›: ${expectedAdminHash})</p>`;
                }

                if (demoHash === expectedDemoHash) {
                    html += '<p class="success">âœ… demo MD5å“ˆå¸Œæ­£ç¡®</p>';
                } else {
                    html += `<p class="error">âŒ demo MD5å“ˆå¸Œä¸åŒ¹é… (æœŸæœ›: ${expectedDemoHash})</p>`;
                }

                html += '<p class="info">ğŸ’¡ å¦‚æœMD5ä¸åŒ¹é…ï¼Œè¯·æ›´æ–°storage.jsä¸­çš„å¯†ç å“ˆå¸Œå€¼</p>';

            } catch (error) {
                html += `<p class="error">âŒ MD5æµ‹è¯•å¤±è´¥: ${error.message}</p>`;
            }

            statusDiv.innerHTML = html;
        }

        function testStorage() {
            const statusDiv = document.getElementById('storage-status');
            let html = '';

            try {
                // æ£€æŸ¥LocalStorageæ˜¯å¦å¯ç”¨
                if (typeof Storage !== 'undefined') {
                    html += '<p class="success">âœ… LocalStorageå¯ç”¨</p>';

                    // æ£€æŸ¥ç”¨æˆ·æ•°æ®
                    const users = Storage.get('users');
                    html += `<p>ç”¨æˆ·æ•°é‡: ${users.length}</p>`;

                    if (users.length > 0) {
                        html += '<p class="info">ç°æœ‰ç”¨æˆ·:</p>';
                        users.forEach(user => {
                            html += `<p>- ${user.username} (${user.role})</p>`;
                        });
                    } else {
                        html += '<p class="info">æš‚æ— ç”¨æˆ·æ•°æ®</p>';
                    }

                    // æ£€æŸ¥å…¶ä»–æ•°æ®
                    const tasks = Storage.get('tasks');
                    const resources = Storage.get('resources');
                    const progress = Storage.get('progress');

                    html += `<p>ä»»åŠ¡æ•°é‡: ${tasks.length}</p>`;
                    html += `<p>èµ„æºæ•°é‡: ${resources.length}</p>`;
                    html += `<p>è¿›åº¦è®°å½•: ${progress.length}</p>`;

                } else {
                    html += '<p class="error">âŒ Storageæ¨¡å—ä¸å¯ç”¨</p>';
                }

            } catch (error) {
                html += `<p class="error">âŒ å­˜å‚¨æµ‹è¯•å¤±è´¥: ${error.message}</p>`;
            }

            statusDiv.innerHTML = html;
        }

        function testAuth() {
            const statusDiv = document.getElementById('auth-status');
            let html = '';

            try {
                if (typeof Auth !== 'undefined') {
                    html += '<p class="success">âœ… Authæ¨¡å—å¯ç”¨</p>';

                    // æ£€æŸ¥ç™»å½•çŠ¶æ€
                    const isLoggedIn = Auth.isLoggedIn();
                    html += `<p>å½“å‰ç™»å½•çŠ¶æ€: ${isLoggedIn ? 'å·²ç™»å½•' : 'æœªç™»å½•'}</p>`;

                    if (isLoggedIn) {
                        const currentUser = Auth.getCurrentUser();
                        html += `<p>å½“å‰ç”¨æˆ·: ${currentUser.username} (${currentUser.role})</p>`;
                    }

                    // æµ‹è¯•ç”¨æˆ·éªŒè¯
                    const testUsers = Storage.get('users');
                    html += '<p class="info">æµ‹è¯•ç”¨æˆ·éªŒè¯:</p>';

                    testUsers.forEach(user => {
                        const testResult = Auth.login(user.username, user.username); // ç”¨æˆ·åä½œä¸ºå¯†ç æµ‹è¯•
                        if (testResult.success) {
                            html += `<p class="success">âœ… ${user.username} éªŒè¯æˆåŠŸ</p>`;
                        } else {
                            html += `<p class="error">âŒ ${user.username} éªŒè¯å¤±è´¥: ${testResult.message}</p>`;
                        }
                    });

                } else {
                    html += '<p class="error">âŒ Authæ¨¡å—ä¸å¯ç”¨</p>';
                }

            } catch (error) {
                html += `<p class="error">âŒ è®¤è¯æµ‹è¯•å¤±è´¥: ${error.message}</p>`;
            }

            statusDiv.innerHTML = html;
        }

        function clearAllData() {
            const statusDiv = document.getElementById('clear-status');

            try {
                localStorage.clear();
                statusDiv.innerHTML = '<p class="success">âœ… æ‰€æœ‰LocalStorageæ•°æ®å·²æ¸…é™¤</p>';
                statusDiv.innerHTML += '<button onclick="location.reload()">é‡æ–°åŠ è½½é¡µé¢</button>';
            } catch (error) {
                statusDiv.innerHTML = `<p class="error">âŒ æ¸…é™¤æ•°æ®å¤±è´¥: ${error.message}</p>`;
            }
        }

        function initDefaultData() {
            const statusDiv = document.getElementById('clear-status');

            try {
                // å¼ºåˆ¶é‡æ–°åˆå§‹åŒ–
                Storage.initializeDefaultData();
                statusDiv.innerHTML = '<p class="success">âœ… é»˜è®¤æ•°æ®å·²é‡æ–°åˆå§‹åŒ–</p>';
                statusDiv.innerHTML += '<button onclick="location.reload()">é‡æ–°åŠ è½½é¡µé¢</button>';
            } catch (error) {
                statusDiv.innerHTML = `<p class="error">âŒ åˆå§‹åŒ–æ•°æ®å¤±è´¥: ${error.message}</p>`;
            }
        }

        function fixUsers() {
            const statusDiv = document.getElementById('clear-status');

            try {
                // ç›´æ¥ä¿®å¤ç”¨æˆ·æ•°æ®
                const users = Storage.get('users');
                const updatedUsers = users.map(user => ({
                    ...user,
                    isActive: true
                }));

                Storage.set('users', updatedUsers);
                statusDiv.innerHTML = '<p class="success">âœ… ç”¨æˆ·isActiveå­—æ®µå·²ä¿®å¤</p>';
                statusDiv.innerHTML += '<p class="info">æ›´æ–°äº† ' + users.length + ' ä¸ªç”¨æˆ·</p>';
                statusDiv.innerHTML += '<button onclick="location.reload()">é‡æ–°åŠ è½½é¡µé¢æµ‹è¯•ç™»å½•</button>';
            } catch (error) {
                statusDiv.innerHTML = `<p class="error">âŒ ä¿®å¤ç”¨æˆ·å¤±è´¥: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>