<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>系统统计 - LearnSync 管理后台</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- 自定义样式 -->
    <link href="../css/dashboard.css" rel="stylesheet">
    <style>
        /* 统计页面特定样式 */
        .stats-overview {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            height: 100%;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 25px rgba(0,0,0,0.15);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }

        .stat-change {
            font-size: 0.85rem;
            padding: 4px 8px;
            border-radius: 12px;
        }

        .stat-change.positive {
            background-color: #e8f5e8;
            color: #2e7d32;
        }

        .stat-change.negative {
            background-color: #ffebee;
            color: #c62828;
        }

        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .chart-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
        }

        .data-table {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
        }

        .table-custom {
            border-radius: 8px;
            overflow: hidden;
        }

        .table-custom thead th {
            background: #f8f9fa;
            border-bottom: none;
            font-weight: 600;
            color: #495057;
        }

        .progress-ring {
            width: 120px;
            height: 120px;
            margin: 0 auto;
        }

        .progress-ring circle {
            transition: stroke-dashoffset 0.35s;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .activity-item {
            display: flex;
            align-items: start;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .activity-content {
            flex: 1;
        }

        .activity-time {
            font-size: 0.8rem;
            color: #666;
        }

        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-item {
            text-align: center;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: #007bff;
            margin-bottom: 8px;
        }

        .metric-label {
            color: #666;
            font-size: 0.9rem;
        }

        .export-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 1000;
        }

        .export-btn .btn {
            border-radius: 50%;
            width: 56px;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html">
                <i class="bi bi-graph-up"></i> LearnSync 管理后台
            </a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">
                            <i class="bi bi-speedometer2"></i> 仪表盘
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="tasks.html">
                            <i class="bi bi-list-task"></i> 任务管理
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="resources.html">
                            <i class="bi bi-book"></i> 资源管理
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="stats.html">
                            <i class="bi bi-bar-chart"></i> 系统统计
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="users.html">
                            <i class="bi bi-people"></i> 用户管理
                        </a>
                    </li>
                </ul>

                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-person-circle"></i> <span id="admin-name">管理员</span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="../index.html"><i class="bi bi-house"></i> 返回首页</a></li>
                            <li><a class="dropdown-item" href="#" onclick="logout()"><i class="bi bi-box-arrow-right"></i> 退出登录</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- 主内容区 -->
    <div class="container-fluid" style="margin-top: 80px;">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="bi bi-bar-chart"></i> 系统统计</h2>
                    <div>
                        <button class="btn btn-outline-primary" onclick="refreshStats()">
                            <i class="bi bi-arrow-clockwise"></i> 刷新数据
                        </button>
                        <button class="btn btn-outline-secondary" onclick="exportStats()">
                            <i class="bi bi-download"></i> 导出报告
                        </button>
                    </div>
                </div>

                <!-- 系统概览 -->
                <div class="stats-overview">
                    <div class="row">
                        <div class="col-md-8">
                            <h3 class="mb-3">系统概览</h3>
                            <p class="mb-4">LearnSync 智能学习任务管理平台运行状态良好</p>
                            <div class="row">
                                <div class="col-md-3 col-6">
                                    <div class="stat-number" id="total-users">0</div>
                                    <div class="stat-label">总用户数</div>
                                </div>
                                <div class="col-md-3 col-6">
                                    <div class="stat-number" id="total-tasks">0</div>
                                    <div class="stat-label">总任务数</div>
                                </div>
                                <div class="col-md-3 col-6">
                                    <div class="stat-number" id="total-resources">0</div>
                                    <div class="stat-label">总资源数</div>
                                </div>
                                <div class="col-md-3 col-6">
                                    <div class="stat-number" id="total-progress">0</div>
                                    <div class="stat-label">学习进度</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center">
                                <h4>系统健康状态</h4>
                                <div class="progress-ring">
                                    <svg width="120" height="120">
                                        <circle cx="60" cy="60" r="50" stroke="#e0e0e0" stroke-width="10" fill="none"/>
                                        <circle id="health-circle" cx="60" cy="60" r="50" stroke="#28a745" stroke-width="10" fill="none"
                                                stroke-dasharray="314" stroke-dashoffset="0"/>
                                    </svg>
                                    <div style="margin-top: -80px;">
                                        <div style="font-size: 1.5rem; font-weight: bold;" id="health-percentage">100%</div>
                                        <div style="font-size: 0.8rem;">健康度</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 关键指标 -->
                <div class="metric-grid">
                    <div class="metric-item">
                        <div class="metric-value" id="active-users">0</div>
                        <div class="metric-label">活跃用户</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value" id="completion-rate">0%</div>
                        <div class="metric-label">任务完成率</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value" id="avg-time">0h</div>
                        <div class="metric-label">平均学习时间</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value" id="new-users-today">0</div>
                        <div class="metric-label">今日新增用户</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value" id="tasks-completed-today">0</div>
                        <div class="metric-label">今日完成任务</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value" id="resources-shared">0</div>
                        <div class="metric-label">资源共享数</div>
                    </div>
                </div>

                <!-- 图表区域 -->
                <div class="row">
                    <!-- 用户增长趋势 -->
                    <div class="col-lg-6 mb-4">
                        <div class="chart-container">
                            <h5 class="chart-title">用户增长趋势</h5>
                            <canvas id="userGrowthChart" width="400" height="200"></canvas>
                        </div>
                    </div>

                    <!-- 任务完成情况 -->
                    <div class="col-lg-6 mb-4">
                        <div class="chart-container">
                            <h5 class="chart-title">任务完成情况</h5>
                            <canvas id="taskCompletionChart" width="400" height="200"></canvas>
                        </div>
                    </div>

                    <!-- 学习时长分布 -->
                    <div class="col-lg-6 mb-4">
                        <div class="chart-container">
                            <h5 class="chart-title">学习时长分布</h5>
                            <canvas id="studyTimeChart" width="400" height="200"></canvas>
                        </div>
                    </div>

                    <!-- 资源类型分布 -->
                    <div class="col-lg-6 mb-4">
                        <div class="chart-container">
                            <h5 class="chart-title">资源类型分布</h5>
                            <canvas id="resourceTypeChart" width="400" height="200"></canvas>
                        </div>
                    </div>

                    <!-- 每日活动统计 -->
                    <div class="col-12 mb-4">
                        <div class="chart-container">
                            <h5 class="chart-title">每日活动统计</h5>
                            <canvas id="dailyActivityChart" width="800" height="300"></canvas>
                        </div>
                    </div>
                </div>

                <!-- 详细数据表格 -->
                <div class="row">
                    <div class="col-lg-8 mb-4">
                        <div class="data-table">
                            <h5 class="mb-4">用户活跃度排行</h5>
                            <div class="table-responsive">
                                <table class="table table-custom">
                                    <thead>
                                        <tr>
                                            <th>排名</th>
                                            <th>用户</th>
                                            <th>任务完成</th>
                                            <th>学习时长</th>
                                            <th>活跃度</th>
                                            <th>最后活动</th>
                                        </tr>
                                    </thead>
                                    <tbody id="userActivityTable">
                                        <!-- 动态生成 -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-4 mb-4">
                        <div class="data-table">
                            <h5 class="mb-4">最近活动</h5>
                            <div id="recentActivity">
                                <!-- 动态生成 -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 浮动导出按钮 -->
    <div class="export-btn">
        <div class="btn-group">
            <button class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown">
                <i class="bi bi-download"></i>
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#" onclick="exportPDF()">导出PDF报告</a></li>
                <li><a class="dropdown-item" href="#" onclick="exportExcel()">导出Excel数据</a></li>
            </ul>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- 引入依赖模块 -->
    <script src="../lib/md5.min.js"></script>
    <script src="../js/storage.js"></script>
    <script src="../js/auth.js"></script>

    <!-- 统计分析脚本 -->
    <script>
        // 全局变量
        let charts = {};

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 验证管理员身份
            if (!Auth.isAdmin()) {
                alert('您没有权限访问此页面');
                window.location.href = '../index.html';
                return;
            }

            // 加载统计数据
            loadStatistics();

            // 更新管理员信息
            updateAdminInfo();
        });

        // 加载统计数据
        function loadStatistics() {
            const users = Storage.get('users');
            const tasks = Storage.get('tasks');
            const resources = Storage.get('resources');
            const progress = Storage.get('progress');

            // 更新概览数据
            updateOverviewStats(users, tasks, resources, progress);

            // 更新关键指标
            updateKeyMetrics(users, tasks, resources, progress);

            // 更新图表
            updateCharts(users, tasks, resources, progress);

            // 更新数据表格
            updateTables(users, tasks, progress);

            // 更新最近活动
            updateRecentActivity(users, tasks, resources, progress);
        }

        // 更新概览统计
        function updateOverviewStats(users, tasks, resources, progress) {
            document.getElementById('total-users').textContent = users.length;
            document.getElementById('total-tasks').textContent = tasks.length;
            document.getElementById('total-resources').textContent = resources.length;
            document.getElementById('total-progress').textContent = progress.length;

            // 计算系统健康度
            const healthScore = calculateSystemHealth(users, tasks, resources);
            updateHealthStatus(healthScore);
        }

        // 计算系统健康度
        function calculateSystemHealth(users, tasks, resources) {
            let score = 100;

            // 检查用户活跃度
            const activeUsers = users.filter(u => u.isActive).length;
            if (activeUsers < users.length * 0.8) score -= 20;

            // 检查任务完成率
            const completedTasks = tasks.filter(t => t.status === 'Completed').length;
            const completionRate = tasks.length > 0 ? completedTasks / tasks.length : 0;
            if (completionRate < 0.5) score -= 15;

            // 检查资源分布
            if (resources.length < users.length * 2) score -= 10;

            return Math.max(0, score);
        }

        // 更新健康状态
        function updateHealthStatus(score) {
            const circle = document.getElementById('health-circle');
            const percentage = document.getElementById('health-percentage');

            percentage.textContent = score + '%';

            // 设置圆环进度
            const circumference = 2 * Math.PI * 50;
            const offset = circumference - (score / 100) * circumference;
            circle.style.strokeDashoffset = offset;

            // 设置颜色
            if (score >= 80) {
                circle.style.stroke = '#28a745'; // 绿色
            } else if (score >= 60) {
                circle.style.stroke = '#ffc107'; // 黄色
            } else {
                circle.style.stroke = '#dc3545'; // 红色
            }
        }

        // 更新关键指标
        function updateKeyMetrics(users, tasks, resources, progress) {
            // 活跃用户
            const activeUsers = users.filter(u => u.isActive).length;
            document.getElementById('active-users').textContent = activeUsers;

            // 任务完成率
            const completedTasks = tasks.filter(t => t.status === 'Completed').length;
            const completionRate = tasks.length > 0 ? Math.round((completedTasks / tasks.length) * 100) : 0;
            document.getElementById('completion-rate').textContent = completionRate + '%';

            // 平均学习时间
            const totalTime = progress.reduce((sum, p) => sum + (p.timeSpent || 0), 0);
            const avgTime = progress.length > 0 ? Math.round(totalTime / progress.length / 60) : 0;
            document.getElementById('avg-time').textContent = avgTime + 'h';

            // 今日新增用户
            const today = new Date().toDateString();
            const todayUsers = users.filter(u => new Date(u.createdAt).toDateString() === today).length;
            document.getElementById('new-users-today').textContent = todayUsers;

            // 今日完成任务
            const todayTasks = tasks.filter(t =>
                t.status === 'Completed' &&
                t.updatedAt &&
                new Date(t.updatedAt).toDateString() === today
            ).length;
            document.getElementById('tasks-completed-today').textContent = todayTasks;

            // 资源共享数
            document.getElementById('resources-shared').textContent = resources.length;
        }

        // 更新图表
        function updateCharts(users, tasks, resources, progress) {
            // 用户增长趋势
            createUserGrowthChart(users);

            // 任务完成情况
            createTaskCompletionChart(tasks);

            // 学习时长分布
            createStudyTimeChart(progress);

            // 资源类型分布
            createResourceTypeChart(resources);

            // 每日活动统计
            createDailyActivityChart(tasks, progress);
        }

        // 创建用户增长趋势图表
        function createUserGrowthChart(users) {
            const ctx = document.getElementById('userGrowthChart').getContext('2d');

            // 按月份分组用户
            const monthlyUsers = groupUsersByMonth(users);

            // 销毁旧图表
            if (charts.userGrowth) {
                charts.userGrowth.destroy();
            }

            charts.userGrowth = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: monthlyUsers.labels,
                    datasets: [{
                        label: '用户数量',
                        data: monthlyUsers.data,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // 按月份分组用户
        function groupUsersByMonth(users) {
            const monthData = {};
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();

            // 初始化过去6个月的数据
            for (let i = 5; i >= 0; i--) {
                const date = new Date(currentYear, currentMonth - i, 1);
                const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                monthData[key] = 0;
            }

            // 统计用户
            users.forEach(user => {
                const date = new Date(user.createdAt);
                const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                if (monthData.hasOwnProperty(key)) {
                    monthData[key]++;
                }
            });

            return {
                labels: Object.keys(monthData).map(key => {
                    const [year, month] = key.split('-');
                    return `${year}年${parseInt(month)}月`;
                }),
                data: Object.values(monthData)
            };
        }

        // 创建任务完成情况图表
        function createTaskCompletionChart(tasks) {
            const ctx = document.getElementById('taskCompletionChart').getContext('2d');

            const statusCounts = {
                '待处理': tasks.filter(t => t.status === 'Todo').length,
                '进行中': tasks.filter(t => t.status === 'InProgress').length,
                '已完成': tasks.filter(t => t.status === 'Completed').length
            };

            if (charts.taskCompletion) {
                charts.taskCompletion.destroy();
            }

            charts.taskCompletion = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(statusCounts),
                    datasets: [{
                        data: Object.values(statusCounts),
                        backgroundColor: [
                            '#6c757d',
                            '#17a2b8',
                            '#28a745'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // 创建学习时长分布图表
        function createStudyTimeChart(progress) {
            const ctx = document.getElementById('studyTimeChart').getContext('2d');

            // 计算学习时长分布
            const timeRanges = {
                '0-2小时': 0,
                '2-5小时': 0,
                '5-10小时': 0,
                '10小时以上': 0
            };

            progress.forEach(p => {
                const hours = (p.timeSpent || 0) / 60;
                if (hours <= 2) timeRanges['0-2小时']++;
                else if (hours <= 5) timeRanges['2-5小时']++;
                else if (hours <= 10) timeRanges['5-10小时']++;
                else timeRanges['10小时以上']++;
            });

            if (charts.studyTime) {
                charts.studyTime.destroy();
            }

            charts.studyTime = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(timeRanges),
                    datasets: [{
                        label: '用户数量',
                        data: Object.values(timeRanges),
                        backgroundColor: '#ffc107'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // 创建资源类型分布图表
        function createResourceTypeChart(resources) {
            const ctx = document.getElementById('resourceTypeChart').getContext('2d');

            const typeCounts = {};
            resources.forEach(resource => {
                const typeName = getResourceTypeName(resource.type);
                typeCounts[typeName] = (typeCounts[typeName] || 0) + 1;
            });

            if (charts.resourceType) {
                charts.resourceType.destroy();
            }

            charts.resourceType = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(typeCounts),
                    datasets: [{
                        data: Object.values(typeCounts),
                        backgroundColor: [
                            '#ff6384',
                            '#36a2eb',
                            '#ffce56',
                            '#4bc0c0',
                            '#9966ff',
                            '#ff9f40'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // 创建每日活动统计图表
        function createDailyActivityChart(tasks, progress) {
            const ctx = document.getElementById('dailyActivityChart').getContext('2d');

            // 获取过去7天的数据
            const dailyData = getDailyActivityData(tasks, progress);

            if (charts.dailyActivity) {
                charts.dailyActivity.destroy();
            }

            charts.dailyActivity = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: dailyData.labels,
                    datasets: [
                        {
                            label: '新建任务',
                            data: dailyData.newTasks,
                            backgroundColor: '#007bff'
                        },
                        {
                            label: '完成任务',
                            data: dailyData.completedTasks,
                            backgroundColor: '#28a745'
                        },
                        {
                            label: '学习进度',
                            data: dailyData.progressEntries,
                            backgroundColor: '#ffc107'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // 获取每日活动数据
        function getDailyActivityData(tasks, progress) {
            const data = {
                labels: [],
                newTasks: [],
                completedTasks: [],
                progressEntries: []
            };

            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toDateString();
                const label = `${date.getMonth() + 1}月${date.getDate()}日`;

                data.labels.push(label);
                data.newTasks.push(tasks.filter(t =>
                    new Date(t.createdAt).toDateString() === dateStr
                ).length);
                data.completedTasks.push(tasks.filter(t =>
                    t.status === 'Completed' &&
                    t.updatedAt &&
                    new Date(t.updatedAt).toDateString() === dateStr
                ).length);
                data.progressEntries.push(progress.filter(p =>
                    new Date(p.createdAt).toDateString() === dateStr
                ).length);
            }

            return data;
        }

        // 获取资源类型名称
        function getResourceTypeName(type) {
            switch (type) {
                case 'article': return '文章';
                case 'video': return '视频';
                case 'book': return '书籍';
                case 'course': return '课程';
                case 'website': return '网站';
                case 'document': return '文档';
                default: return type;
            }
        }

        // 更新数据表格
        function updateTables(users, tasks, progress) {
            updateUserActivityTable(users, tasks, progress);
        }

        // 更新用户活跃度表格
        function updateUserActivityTable(users, tasks, progress) {
            const tbody = document.getElementById('userActivityTable');
            const userStats = [];

            users.forEach(user => {
                const userTasks = tasks.filter(t => t.userId === user.id);
                const userProgress = progress.filter(p => p.userId === user.id);

                const completedTasks = userTasks.filter(t => t.status === 'Completed').length;
                const totalStudyTime = userProgress.reduce((sum, p) => sum + (p.timeSpent || 0), 0);
                const lastActivity = userProgress.length > 0 ?
                    new Date(Math.max(...userProgress.map(p => new Date(p.createdAt)))) : null;

                userStats.push({
                    user,
                    completedTasks,
                    totalStudyTime,
                    lastActivity,
                    activityScore: calculateActivityScore(userTasks, userProgress)
                });
            });

            // 按活跃度排序
            userStats.sort((a, b) => b.activityScore - a.activityScore);

            // 生成表格HTML
            let html = '';
            userStats.slice(0, 10).forEach((stat, index) => {
                const user = stat.user;
                const hours = Math.round(stat.totalStudyTime / 60);
                const lastActivityText = stat.lastActivity ?
                    formatRelativeTime(stat.lastActivity) : '无活动';

                html += `
                    <tr>
                        <td><strong>${index + 1}</strong></td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="user-avatar me-2">${user.username.charAt(0).toUpperCase()}</div>
                                <div>
                                    <div>${user.username}</div>
                                    <small class="text-muted">${user.role}</small>
                                </div>
                            </div>
                        </td>
                        <td>${stat.completedTasks}</td>
                        <td>${hours}h</td>
                        <td>
                            <div class="progress" style="height: 6px;">
                                <div class="progress-bar bg-success" style="width: ${stat.activityScore}%"></div>
                            </div>
                            <small>${stat.activityScore}%</small>
                        </td>
                        <td><small>${lastActivityText}</small></td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        }

        // 计算用户活跃度分数
        function calculateActivityScore(userTasks, userProgress) {
            let score = 0;

            // 任务完成情况 (40%)
            const completedTasks = userTasks.filter(t => t.status === 'Completed').length;
            score += Math.min(40, completedTasks * 10);

            // 学习时长 (30%)
            const totalHours = userProgress.reduce((sum, p) => sum + (p.timeSpent || 0), 0) / 60;
            score += Math.min(30, totalHours * 3);

            // 学习记录数量 (30%)
            score += Math.min(30, userProgress.length * 5);

            return Math.min(100, Math.round(score));
        }

        // 格式化相对时间
        function formatRelativeTime(date) {
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (minutes < 1) return '刚刚';
            if (minutes < 60) return `${minutes}分钟前`;
            if (hours < 24) return `${hours}小时前`;
            if (days < 7) return `${days}天前`;
            return date.toLocaleDateString('zh-CN');
        }

        // 更新最近活动
        function updateRecentActivity(users, tasks, resources, progress) {
            const container = document.getElementById('recentActivity');
            const activities = [];

            // 收集所有活动
            users.forEach(user => {
                activities.push({
                    type: 'user',
                    user,
                    date: new Date(user.createdAt),
                    title: `${user.username} 加入了平台`,
                    icon: 'bi-person-plus',
                    color: '#007bff'
                });
            });

            tasks.forEach(task => {
                const user = Storage.getById('users', task.userId);
                activities.push({
                    type: 'task',
                    user,
                    date: new Date(task.createdAt),
                    title: `${user ? user.username : '用户'} 创建了任务 "${task.title}"`,
                    icon: 'bi-plus-circle',
                    color: '#28a745'
                });

                if (task.status === 'Completed' && task.updatedAt) {
                    activities.push({
                        type: 'task_complete',
                        user,
                        date: new Date(task.updatedAt),
                        title: `${user ? user.username : '用户'} 完成了任务 "${task.title}"`,
                        icon: 'bi-check-circle',
                        color: '#28a745'
                    });
                }
            });

            resources.forEach(resource => {
                const user = Storage.getById('users', resource.userId);
                activities.push({
                    type: 'resource',
                    user,
                    date: new Date(resource.createdAt),
                    title: `${user ? user.username : '用户'} 分享了资源 "${resource.name}"`,
                    icon: 'bi-book',
                    color: '#ffc107'
                });
            });

            progress.forEach(entry => {
                const user = Storage.getById('users', entry.userId);
                const task = Storage.getById('tasks', entry.taskId);
                activities.push({
                    type: 'progress',
                    user,
                    date: new Date(entry.createdAt),
                    title: `${user ? user.username : '用户'} 记录了学习进度`,
                    icon: 'bi-graph-up',
                    color: '#17a2b8'
                });
            });

            // 按时间排序
            activities.sort((a, b) => b.date - a.date);

            // 显示最近10条活动
            let html = '';
            activities.slice(0, 10).forEach(activity => {
                html += `
                    <div class="activity-item">
                        <div class="activity-icon" style="background-color: ${activity.color}20; color: ${activity.color};">
                            <i class="bi ${activity.icon}"></i>
                        </div>
                        <div class="activity-content">
                            <div>${activity.title}</div>
                            <div class="activity-time">${formatRelativeTime(activity.date)}</div>
                        </div>
                    </div>
                `;
            });

            if (activities.length === 0) {
                html = '<div class="text-center text-muted py-4">暂无活动记录</div>';
            }

            container.innerHTML = html;
        }

        // 刷新统计数据
        function refreshStats() {
            loadStatistics();
            showSuccess('统计数据已刷新');
        }

        // 导出统计数据
        function exportStats() {
            // 这里可以实现更详细的导出功能
            const data = {
                exportTime: new Date().toISOString(),
                statistics: {
                    totalUsers: document.getElementById('total-users').textContent,
                    totalTasks: document.getElementById('total-tasks').textContent,
                    totalResources: document.getElementById('total-resources').textContent,
                    activeUsers: document.getElementById('active-users').textContent,
                    completionRate: document.getElementById('completion-rate').textContent,
                    avgTime: document.getElementById('avg-time').textContent
                }
            };

            const json = JSON.stringify(data, null, 2);
            downloadFile(json, `system_stats_${new Date().toISOString().slice(0, 10)}.json`, 'application/json');
            showSuccess('统计数据导出成功');
        }

        // 导出PDF报告 (占位功能)
        function exportPDF() {
            showSuccess('PDF导出功能开发中...');
        }

        // 导出Excel数据 (占位功能)
        function exportExcel() {
            showSuccess('Excel导出功能开发中...');
        }

        // 下载文件
        function downloadFile(content, filename, contentType) {
            const blob = new Blob([content], { type: contentType });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');

            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // 更新管理员信息
        function updateAdminInfo() {
            const admin = Auth.getCurrentUser();
            if (admin) {
                document.getElementById('admin-name').textContent = admin.username;
            }
        }

        // 显示成功消息
        function showSuccess(message) {
            alert(message); // 临时使用alert，实际项目中可以使用toast组件
        }

        // 显示错误消息
        function showError(message) {
            alert(message); // 临时使用alert，实际项目中可以使用toast组件
        }

        // 退出登录
        function logout() {
            Auth.logout();
            window.location.href = '../index.html';
        }
    </script>
</body>
</html>