<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>任务管理 - LearnSync 管理后台</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">

    <!-- 自定义样式 -->
    <link href="../css/dashboard.css" rel="stylesheet">
    <style>
        /* 任务管理特定样式 */
        .task-priority-high { border-left: 4px solid #dc3545; }
        .task-priority-medium { border-left: 4px solid #ffc107; }
        .task-priority-low { border-left: 4px solid #28a745; }

        .task-status-todo { background-color: #f8f9fa; }
        .task-status-inprogress { background-color: #e3f2fd; }
        .task-status-completed { background-color: #e8f5e8; }
        .task-status-overdue { background-color: #ffebee; }

        .priority-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            font-weight: 600;
        }

        .stats-card {
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }

        .stats-card:hover {
            transform: translateY(-3px);
        }

        .task-card {
            border-radius: 8px;
            margin-bottom: 15px;
            transition: all 0.2s;
        }

        .task-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .task-filters {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .progress-ring {
            transition: stroke-dashoffset 0.35s;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }

        .status-count {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .assignee-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .task-deadline-warning {
            color: #ff9800;
            font-weight: 600;
        }

        .task-deadline-danger {
            color: #f44336;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html">
                <i class="bi bi-graph-up"></i> LearnSync 管理后台
            </a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">
                            <i class="bi bi-speedometer2"></i> 仪表盘
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="tasks.html">
                            <i class="bi bi-list-task"></i> 任务管理
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="resources.html">
                            <i class="bi bi-book"></i> 资源管理
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="stats.html">
                            <i class="bi bi-bar-chart"></i> 系统统计
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="users.html">
                            <i class="bi bi-people"></i> 用户管理
                        </a>
                    </li>
                </ul>

                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-person-circle"></i> <span id="admin-name">管理员</span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="../index.html"><i class="bi bi-house"></i> 返回首页</a></li>
                            <li><a class="dropdown-item" href="#" onclick="logout()"><i class="bi bi-box-arrow-right"></i> 退出登录</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- 主内容区 -->
    <div class="container-fluid" style="margin-top: 80px;">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="bi bi-list-task"></i> 任务管理</h2>
                    <div>
                        <button class="btn btn-outline-secondary" onclick="exportTasks()">
                            <i class="bi bi-download"></i> 导出
                        </button>
                        <button class="btn btn-outline-primary" onclick="refreshTasks()">
                            <i class="bi bi-arrow-clockwise"></i> 刷新
                        </button>
                        <button class="btn btn-primary" onclick="showAddTaskModal()">
                            <i class="bi bi-plus-circle"></i> 新建任务
                        </button>
                    </div>
                </div>

                <!-- 任务统计卡片 -->
                <div class="row mb-4">
                    <div class="col-md-2 col-sm-6 mb-3">
                        <div class="stats-card bg-white text-center p-3">
                            <div class="status-count text-primary" id="total-tasks-count">0</div>
                            <div class="text-muted small">总任务数</div>
                        </div>
                    </div>
                    <div class="col-md-2 col-sm-6 mb-3">
                        <div class="stats-card bg-white text-center p-3">
                            <div class="status-count text-secondary" id="todo-count">0</div>
                            <div class="text-muted small">待处理</div>
                        </div>
                    </div>
                    <div class="col-md-2 col-sm-6 mb-3">
                        <div class="stats-card bg-white text-center p-3">
                            <div class="status-count text-info" id="inprogress-count">0</div>
                            <div class="text-muted small">进行中</div>
                        </div>
                    </div>
                    <div class="col-md-2 col-sm-6 mb-3">
                        <div class="stats-card bg-white text-center p-3">
                            <div class="status-count text-success" id="completed-count">0</div>
                            <div class="text-muted small">已完成</div>
                        </div>
                    </div>
                    <div class="col-md-2 col-sm-6 mb-3">
                        <div class="stats-card bg-white text-center p-3">
                            <div class="status-count text-warning" id="overdue-count">0</div>
                            <div class="text-muted small">已逾期</div>
                        </div>
                    </div>
                    <div class="col-md-2 col-sm-6 mb-3">
                        <div class="stats-card bg-white text-center p-3">
                            <div class="status-count text-danger" id="high-priority-count">0</div>
                            <div class="text-muted small">高优先级</div>
                        </div>
                    </div>
                </div>

                <!-- 搜索和过滤 -->
                <div class="task-filters">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label for="search-input" class="form-label">搜索任务</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="search-input" placeholder="搜索任务标题或描述...">
                                <button class="btn btn-outline-secondary" type="button" onclick="searchTasks()">
                                    <i class="bi bi-search"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <label for="status-filter" class="form-label">状态</label>
                            <select class="form-select" id="status-filter" onchange="filterTasks()">
                                <option value="">全部状态</option>
                                <option value="Todo">待处理</option>
                                <option value="InProgress">进行中</option>
                                <option value="Completed">已完成</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="priority-filter" class="form-label">优先级</label>
                            <select class="form-select" id="priority-filter" onchange="filterTasks()">
                                <option value="">全部优先级</option>
                                <option value="High">高</option>
                                <option value="Medium">中</option>
                                <option value="Low">低</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="assignee-filter" class="form-label">指派人</label>
                            <select class="form-select" id="assignee-filter" onchange="filterTasks()">
                                <option value="">全部用户</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="sort-order" class="form-label">排序</label>
                            <select class="form-select" id="sort-order" onchange="sortTasks()">
                                <option value="created-desc">创建时间 (新到旧)</option>
                                <option value="created-asc">创建时间 (旧到新)</option>
                                <option value="deadline-asc">截止时间 (近到远)</option>
                                <option value="deadline-desc">截止时间 (远到近)</option>
                                <option value="priority-desc">优先级 (高到低)</option>
                                <option value="title-asc">标题 (A-Z)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- 批量操作 -->
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="select-all-tasks" onchange="toggleSelectAll()">
                            <label class="form-check-label" for="select-all-tasks">全选</label>
                        </div>
                        <button class="btn btn-sm btn-outline-primary" onclick="batchUpdateStatus()">批量更新状态</button>
                        <button class="btn btn-sm btn-outline-warning" onclick="batchUpdatePriority()">批量更新优先级</button>
                        <button class="btn btn-sm btn-outline-danger" onclick="batchDeleteTasks()">批量删除</button>
                    </div>
                    <div class="text-muted">
                        共 <span id="filtered-count">0</span> 个任务
                    </div>
                </div>

                <!-- 任务列表 -->
                <div id="tasks-container">
                    <!-- 任务将通过JavaScript动态加载 -->
                </div>

                <!-- 分页 -->
                <nav aria-label="任务分页" class="mt-4">
                    <ul class="pagination justify-content-center" id="pagination">
                        <!-- 分页将通过JavaScript动态生成 -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>

    <!-- 添加/编辑任务模态框 -->
    <div class="modal fade" id="taskModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="taskModalTitle">新建任务</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="taskForm">
                        <input type="hidden" id="taskId">

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="task-title" class="form-label">任务标题 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="task-title" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="task-assignee" class="form-label">指派人 <span class="text-danger">*</span></label>
                                <select class="form-select" id="task-assignee" required>
                                    <option value="">选择用户</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="task-description" class="form-label">任务描述</label>
                            <textarea class="form-control" id="task-description" rows="3"></textarea>
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="task-priority" class="form-label">优先级 <span class="text-danger">*</span></label>
                                <select class="form-select" id="task-priority" required>
                                    <option value="Low">低</option>
                                    <option value="Medium" selected>中</option>
                                    <option value="High">高</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="task-status" class="form-label">状态 <span class="text-danger">*</span></label>
                                <select class="form-select" id="task-status" required>
                                    <option value="Todo" selected>待处理</option>
                                    <option value="InProgress">进行中</option>
                                    <option value="Completed">已完成</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="task-deadline" class="form-label">截止日期</label>
                                <input type="datetime-local" class="form-control" id="task-deadline">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveTask()">保存任务</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 批量更新状态模态框 -->
    <div class="modal fade" id="batchStatusModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">批量更新状态</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <label for="batch-status" class="form-label">新状态</label>
                    <select class="form-select" id="batch-status">
                        <option value="Todo">待处理</option>
                        <option value="InProgress">进行中</option>
                        <option value="Completed">已完成</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="confirmBatchUpdateStatus()">确认更新</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 批量更新优先级模态框 -->
    <div class="modal fade" id="batchPriorityModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">批量更新优先级</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <label for="batch-priority" class="form-label">新优先级</label>
                    <select class="form-select" id="batch-priority">
                        <option value="Low">低</option>
                        <option value="Medium">中</option>
                        <option value="High">高</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="confirmBatchUpdatePriority()">确认更新</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- 引入依赖模块 -->
    <script src="../lib/md5.min.js"></script>
    <script src="../js/storage.js"></script>
    <script src="../js/auth.js"></script>

    <!-- 任务管理脚本 -->
    <script>
        // 全局变量
        let allTasks = [];
        let filteredTasks = [];
        let currentPage = 1;
        const tasksPerPage = 10;
        let selectedTaskIds = new Set();

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 验证管理员身份
            if (!Auth.isAdmin()) {
                alert('您没有权限访问此页面');
                window.location.href = '../index.html';
                return;
            }

            // 加载任务数据
            loadTasks();

            // 更新管理员信息
            updateAdminInfo();
        });

        // 加载任务数据
        function loadTasks() {
            allTasks = Storage.get('tasks');
            filteredTasks = [...allTasks];

            updateTaskStatistics();
            updateAssigneeFilter();
            displayTasks();
            updatePagination();
        }

        // 更新任务统计
        function updateTaskStatistics() {
            const stats = {
                total: allTasks.length,
                todo: allTasks.filter(t => t.status === 'Todo').length,
                inprogress: allTasks.filter(t => t.status === 'InProgress').length,
                completed: allTasks.filter(t => t.status === 'Completed').length,
                overdue: allTasks.filter(t => {
                    return t.deadline && new Date(t.deadline) < new Date() && t.status !== 'Completed';
                }).length,
                highPriority: allTasks.filter(t => t.priority === 'High').length
            };

            document.getElementById('total-tasks-count').textContent = stats.total;
            document.getElementById('todo-count').textContent = stats.todo;
            document.getElementById('inprogress-count').textContent = stats.inprogress;
            document.getElementById('completed-count').textContent = stats.completed;
            document.getElementById('overdue-count').textContent = stats.overdue;
            document.getElementById('high-priority-count').textContent = stats.highPriority;
        }

        // 更新指派人过滤选项
        function updateAssigneeFilter() {
            const users = Storage.get('users');
            const assigneeFilter = document.getElementById('assignee-filter');
            const taskAssignee = document.getElementById('task-assignee');

            // 清空现有选项
            assigneeFilter.innerHTML = '<option value="">全部用户</option>';
            taskAssignee.innerHTML = '<option value="">选择用户</option>';

            // 添加用户选项
            users.forEach(user => {
                if (user.isActive) {
                    const option1 = new Option(`${user.username} (${user.role})`, user.id);
                    const option2 = new Option(`${user.username} (${user.role})`, user.id);
                    assigneeFilter.add(option1);
                    taskAssignee.add(option2);
                }
            });
        }

        // 显示任务列表
        function displayTasks() {
            const container = document.getElementById('tasks-container');
            document.getElementById('filtered-count').textContent = filteredTasks.length;

            if (filteredTasks.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="bi bi-inbox display-1 text-muted"></i>
                        <h5 class="text-muted mt-3">暂无任务</h5>
                        <button class="btn btn-primary" onclick="showAddTaskModal()">创建第一个任务</button>
                    </div>
                `;
                return;
            }

            // 计算分页
            const startIndex = (currentPage - 1) * tasksPerPage;
            const endIndex = startIndex + tasksPerPage;
            const tasksToShow = filteredTasks.slice(startIndex, endIndex);

            let html = '';
            tasksToShow.forEach(task => {
                const user = Storage.getById('users', task.userId);
                const isOverdue = task.deadline && new Date(task.deadline) < new Date() && task.status !== 'Completed';
                const statusClass = getStatusClass(task.status);
                const priorityClass = getPriorityClass(task.priority);

                html += `
                    <div class="task-card card ${statusClass} ${priorityClass}">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-auto">
                                    <div class="form-check">
                                        <input class="form-check-input task-checkbox" type="checkbox"
                                               value="${task.id}" onchange="toggleTaskSelection('${task.id}')">
                                    </div>
                                </div>
                                <div class="col-md-5">
                                    <h6 class="card-title mb-1">${task.title}</h6>
                                    <p class="card-text text-muted small mb-2">${task.description || '暂无描述'}</p>
                                    <div class="d-flex align-items-center">
                                        <div class="assignee-avatar me-2">${user ? user.username.charAt(0).toUpperCase() : '?'}</div>
                                        <span class="small text-muted">${user ? user.username : '未知用户'}</span>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <span class="badge priority-badge bg-${getPriorityBadgeClass(task.priority)}">
                                        ${getPriorityText(task.priority)}
                                    </span>
                                </div>
                                <div class="col-md-2">
                                    <span class="badge bg-${getStatusBadgeClass(task.status)}">
                                        ${getStatusText(task.status)}
                                    </span>
                                    ${isOverdue ? '<br><span class="text-danger small">已逾期</span>' : ''}
                                </div>
                                <div class="col-md-1">
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="dropdown">
                                            <i class="bi bi-three-dots"></i>
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item" href="#" onclick="editTask('${task.id}')">
                                                <i class="bi bi-pencil"></i> 编辑
                                            </a></li>
                                            <li><a class="dropdown-item" href="#" onclick="changeTaskStatus('${task.id}')">
                                                <i class="bi bi-flag"></i> 更改状态
                                            </a></li>
                                            <li><a class="dropdown-item" href="#" onclick="changeTaskPriority('${task.id}')">
                                                <i class="bi bi-exclamation-triangle"></i> 更改优先级
                                            </a></li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li><a class="dropdown-item text-danger" href="#" onclick="deleteTask('${task.id}')">
                                                <i class="bi bi-trash"></i> 删除
                                            </a></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            ${task.deadline ? `
                                <div class="row mt-2">
                                    <div class="col-12">
                                        <small class="text-muted">
                                            <i class="bi bi-calendar"></i> 截止: ${formatDate(task.deadline)}
                                            ${getTimeRemaining(task.deadline)}
                                        </small>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // 获取状态类名
        function getStatusClass(status) {
            switch (status) {
                case 'Todo': return 'task-status-todo';
                case 'InProgress': return 'task-status-inprogress';
                case 'Completed': return 'task-status-completed';
                default: return '';
            }
        }

        // 获取优先级类名
        function getPriorityClass(priority) {
            switch (priority) {
                case 'High': return 'task-priority-high';
                case 'Medium': return 'task-priority-medium';
                case 'Low': return 'task-priority-low';
                default: return '';
            }
        }

        // 获取状态徽章类
        function getStatusBadgeClass(status) {
            switch (status) {
                case 'Todo': return 'secondary';
                case 'InProgress': return 'info';
                case 'Completed': return 'success';
                default: return 'secondary';
            }
        }

        // 获取优先级徽章类
        function getPriorityBadgeClass(priority) {
            switch (priority) {
                case 'High': return 'danger';
                case 'Medium': return 'warning';
                case 'Low': return 'success';
                default: return 'secondary';
            }
        }

        // 获取状态文本
        function getStatusText(status) {
            switch (status) {
                case 'Todo': return '待处理';
                case 'InProgress': return '进行中';
                case 'Completed': return '已完成';
                default: return status;
            }
        }

        // 获取优先级文本
        function getPriorityText(priority) {
            switch (priority) {
                case 'High': return '高优先级';
                case 'Medium': return '中优先级';
                case 'Low': return '低优先级';
                default: return priority;
            }
        }

        // 格式化日期
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('zh-CN');
        }

        // 获取剩余时间
        function getTimeRemaining(deadline) {
            const now = new Date();
            const deadlineDate = new Date(deadline);
            const diffTime = deadlineDate - now;

            if (diffTime < 0) {
                return '';
            }

            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays === 0) {
                return '<span class="text-warning">今天到期</span>';
            } else if (diffDays === 1) {
                return '<span class="text-warning">明天到期</span>';
            } else if (diffDays <= 3) {
                return `<span class="text-warning">${diffDays}天后到期</span>`;
            } else {
                return `<span class="text-success">${diffDays}天后到期</span>`;
            }
        }

        // 搜索任务
        function searchTasks() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase().trim();

            if (!searchTerm) {
                filteredTasks = [...allTasks];
            } else {
                filteredTasks = allTasks.filter(task =>
                    task.title.toLowerCase().includes(searchTerm) ||
                    (task.description && task.description.toLowerCase().includes(searchTerm))
                );
            }

            currentPage = 1;
            displayTasks();
            updatePagination();
        }

        // 过滤任务
        function filterTasks() {
            const statusFilter = document.getElementById('status-filter').value;
            const priorityFilter = document.getElementById('priority-filter').value;
            const assigneeFilter = document.getElementById('assignee-filter').value;

            filteredTasks = allTasks.filter(task => {
                let matchStatus = !statusFilter || task.status === statusFilter;
                let matchPriority = !priorityFilter || task.priority === priorityFilter;
                let matchAssignee = !assigneeFilter || task.userId === assigneeFilter;

                return matchStatus && matchPriority && matchAssignee;
            });

            currentPage = 1;
            displayTasks();
            updatePagination();
        }

        // 排序任务
        function sortTasks() {
            const sortOrder = document.getElementById('sort-order').value;

            switch (sortOrder) {
                case 'created-desc':
                    filteredTasks.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    break;
                case 'created-asc':
                    filteredTasks.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
                    break;
                case 'deadline-asc':
                    filteredTasks.sort((a, b) => {
                        if (!a.deadline) return 1;
                        if (!b.deadline) return -1;
                        return new Date(a.deadline) - new Date(b.deadline);
                    });
                    break;
                case 'deadline-desc':
                    filteredTasks.sort((a, b) => {
                        if (!a.deadline) return 1;
                        if (!b.deadline) return -1;
                        return new Date(b.deadline) - new Date(a.deadline);
                    });
                    break;
                case 'priority-desc':
                    const priorityOrder = { High: 3, Medium: 2, Low: 1 };
                    filteredTasks.sort((a, b) => priorityOrder[b.priority] - priorityOrder[a.priority]);
                    break;
                case 'title-asc':
                    filteredTasks.sort((a, b) => a.title.localeCompare(b.title));
                    break;
            }

            displayTasks();
            updatePagination();
        }

        // 更新分页
        function updatePagination() {
            const totalPages = Math.ceil(filteredTasks.length / tasksPerPage);
            const pagination = document.getElementById('pagination');

            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            let html = '';

            // 上一页
            html += `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">上一页</a>
                </li>
            `;

            // 页码
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    html += `
                        <li class="page-item ${i === currentPage ? 'active' : ''}">
                            <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                        </li>
                    `;
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    html += '<li class="page-item disabled"><a class="page-link">...</a></li>';
                }
            }

            // 下一页
            html += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">下一页</a>
                </li>
            `;

            pagination.innerHTML = html;
        }

        // 切换页面
        function changePage(page) {
            const totalPages = Math.ceil(filteredTasks.length / tasksPerPage);
            if (page < 1 || page > totalPages) return;

            currentPage = page;
            displayTasks();
            updatePagination();
        }

        // 显示添加任务模态框
        function showAddTaskModal() {
            document.getElementById('taskModalTitle').textContent = '新建任务';
            document.getElementById('taskForm').reset();
            document.getElementById('taskId').value = '';

            // 设置默认截止时间为一周后
            const defaultDeadline = new Date();
            defaultDeadline.setDate(defaultDeadline.getDate() + 7);
            document.getElementById('task-deadline').value = defaultDeadline.toISOString().slice(0, 16);

            const modal = new bootstrap.Modal(document.getElementById('taskModal'));
            modal.show();
        }

        // 编辑任务
        function editTask(taskId) {
            const task = Storage.getById('tasks', taskId);
            if (!task) return;

            document.getElementById('taskModalTitle').textContent = '编辑任务';
            document.getElementById('taskId').value = task.id;
            document.getElementById('task-title').value = task.title;
            document.getElementById('task-description').value = task.description || '';
            document.getElementById('task-priority').value = task.priority;
            document.getElementById('task-status').value = task.status;
            document.getElementById('task-assignee').value = task.userId;

            if (task.deadline) {
                document.getElementById('task-deadline').value = new Date(task.deadline).toISOString().slice(0, 16);
            }

            const modal = new bootstrap.Modal(document.getElementById('taskModal'));
            modal.show();
        }

        // 保存任务
        function saveTask() {
            const taskId = document.getElementById('taskId').value;
            const title = document.getElementById('task-title').value.trim();
            const description = document.getElementById('task-description').value.trim();
            const priority = document.getElementById('task-priority').value;
            const status = document.getElementById('task-status').value;
            const userId = document.getElementById('task-assignee').value;
            let deadline = document.getElementById('task-deadline').value;

            // 验证必填字段
            if (!title || !userId) {
                alert('请填写任务标题和指派人');
                return;
            }

            const taskData = {
                title,
                description,
                priority,
                status,
                userId,
                deadline: deadline ? new Date(deadline).toISOString() : null
            };

            let result;
            if (taskId) {
                // 更新现有任务
                result = Storage.update('tasks', taskId, taskData);
            } else {
                // 创建新任务
                result = Storage.add('tasks', taskData);
            }

            if (result) {
                const modal = bootstrap.Modal.getInstance(document.getElementById('taskModal'));
                modal.hide();
                loadTasks();
                showSuccess(taskId ? '任务更新成功' : '任务创建成功');
            } else {
                showError('保存失败，请重试');
            }
        }

        // 删除任务
        function deleteTask(taskId) {
            if (!confirm('确定要删除这个任务吗？此操作不可恢复。')) {
                return;
            }

            const success = Storage.delete('tasks', taskId);
            if (success) {
                loadTasks();
                showSuccess('任务删除成功');
            } else {
                showError('删除失败，请重试');
            }
        }

        // 更改任务状态
        function changeTaskStatus(taskId) {
            const task = Storage.getById('tasks', taskId);
            if (!task) return;

            const statusFlow = {
                'Todo': 'InProgress',
                'InProgress': 'Completed',
                'Completed': 'Todo'
            };

            const newStatus = statusFlow[task.status];
            const success = Storage.update('tasks', taskId, { status: newStatus });

            if (success) {
                loadTasks();
                showSuccess(`任务状态已更新为: ${getStatusText(newStatus)}`);
            }
        }

        // 更改任务优先级
        function changeTaskPriority(taskId) {
            const task = Storage.getById('tasks', taskId);
            if (!task) return;

            const priorityFlow = {
                'Low': 'Medium',
                'Medium': 'High',
                'High': 'Low'
            };

            const newPriority = priorityFlow[task.priority];
            const success = Storage.update('tasks', taskId, { priority: newPriority });

            if (success) {
                loadTasks();
                showSuccess(`任务优先级已更新为: ${getPriorityText(newPriority)}`);
            }
        }

        // 切换全选
        function toggleSelectAll() {
            const selectAll = document.getElementById('select-all-tasks').checked;
            const checkboxes = document.querySelectorAll('.task-checkbox');

            selectedTaskIds.clear();
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll;
                if (selectAll) {
                    selectedTaskIds.add(checkbox.value);
                }
            });
        }

        // 切换任务选择
        function toggleTaskSelection(taskId) {
            if (selectedTaskIds.has(taskId)) {
                selectedTaskIds.delete(taskId);
            } else {
                selectedTaskIds.add(taskId);
            }
        }

        // 批量更新状态
        function batchUpdateStatus() {
            if (selectedTaskIds.size === 0) {
                alert('请先选择要更新的任务');
                return;
            }

            const modal = new bootstrap.Modal(document.getElementById('batchStatusModal'));
            modal.show();
        }

        // 确认批量更新状态
        function confirmBatchUpdateStatus() {
            const newStatus = document.getElementById('batch-status').value;

            let successCount = 0;
            selectedTaskIds.forEach(taskId => {
                if (Storage.update('tasks', taskId, { status: newStatus })) {
                    successCount++;
                }
            });

            const modal = bootstrap.Modal.getInstance(document.getElementById('batchStatusModal'));
            modal.hide();

            loadTasks();
            showSuccess(`成功更新 ${successCount} 个任务的状态`);
        }

        // 批量更新优先级
        function batchUpdatePriority() {
            if (selectedTaskIds.size === 0) {
                alert('请先选择要更新的任务');
                return;
            }

            const modal = new bootstrap.Modal(document.getElementById('batchPriorityModal'));
            modal.show();
        }

        // 确认批量更新优先级
        function confirmBatchUpdatePriority() {
            const newPriority = document.getElementById('batch-priority').value;

            let successCount = 0;
            selectedTaskIds.forEach(taskId => {
                if (Storage.update('tasks', taskId, { priority: newPriority })) {
                    successCount++;
                }
            });

            const modal = bootstrap.Modal.getInstance(document.getElementById('batchPriorityModal'));
            modal.hide();

            loadTasks();
            showSuccess(`成功更新 ${successCount} 个任务的优先级`);
        }

        // 批量删除任务
        function batchDeleteTasks() {
            if (selectedTaskIds.size === 0) {
                alert('请先选择要删除的任务');
                return;
            }

            if (!confirm(`确定要删除选中的 ${selectedTaskIds.size} 个任务吗？此操作不可恢复。`)) {
                return;
            }

            let successCount = 0;
            selectedTaskIds.forEach(taskId => {
                if (Storage.delete('tasks', taskId)) {
                    successCount++;
                }
            });

            loadTasks();
            showSuccess(`成功删除 ${successCount} 个任务`);
        }

        // 导出任务数据
        function exportTasks() {
            try {
                const data = filteredTasks.map(task => {
                    const user = Storage.getById('users', task.userId);
                    return {
                        '任务标题': task.title,
                        '描述': task.description || '',
                        '指派人': user ? user.username : '未知用户',
                        '优先级': getPriorityText(task.priority),
                        '状态': getStatusText(task.status),
                        '截止时间': task.deadline ? formatDate(task.deadline) : '',
                        '创建时间': formatDate(task.createdAt),
                        '更新时间': formatDate(task.updatedAt || task.createdAt)
                    };
                });

                const csv = convertToCSV(data);
                downloadCSV(csv, `tasks_export_${new Date().toISOString().slice(0, 10)}.csv`);
                showSuccess('任务数据导出成功');
            } catch (error) {
                console.error('导出失败:', error);
                showError('导出失败，请重试');
            }
        }

        // 转换为CSV格式
        function convertToCSV(data) {
            if (data.length === 0) return '';

            const headers = Object.keys(data[0]);
            const csvRows = [headers.join(',')];

            data.forEach(row => {
                const values = headers.map(header => {
                    const value = row[header] || '';
                    return `"${value.toString().replace(/"/g, '""')}"`;
                });
                csvRows.push(values.join(','));
            });

            return csvRows.join('\n');
        }

        // 下载CSV文件
        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);

            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // 刷新任务列表
        function refreshTasks() {
            loadTasks();
            showSuccess('任务列表已刷新');
        }

        // 更新管理员信息
        function updateAdminInfo() {
            const admin = Auth.getCurrentUser();
            if (admin) {
                document.getElementById('admin-name').textContent = admin.username;
            }
        }

        // 显示成功消息
        function showSuccess(message) {
            // 使用toast或其他友好的提示方式
            alert(message); // 临时使用alert，实际项目中可以使用toast组件
        }

        // 显示错误消息
        function showError(message) {
            alert(message); // 临时使用alert，实际项目中可以使用toast组件
        }

        // 退出登录
        function logout() {
            Auth.logout();
            window.location.href = '../index.html';
        }
    </script>
</body>
</html>